---
// src/components/LeadForm.astro
const VACANCY_ID = import.meta.env.CRM_VACANCY_ID;
const COMPANY_NAME = import.meta.env.COMPANY_NAME || 'DARTRANS & HENZEL Sp. z o.o.';
const COMPANY_ADDRESS_STREET = import.meta.env.COMPANY_ADDRESS_STREET || 'ul. Główna 97';
const COMPANY_ADDRESS_POSTAL = import.meta.env.COMPANY_ADDRESS_POSTAL || '62-007';
const COMPANY_ADDRESS_CITY = import.meta.env.COMPANY_ADDRESS_CITY || 'Biskupice';
---

<section id="apply" class="py-24 md:py-32 bg-neutral relative overflow-hidden reveal">
  <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-primary/10 via-transparent to-transparent -z-10"></div>

  <div class="max-w-[85rem] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 justify-items-center lg:items-start">
      
      <div class="w-full lg:sticky lg:top-32 text-center lg:text-left reveal reveal-delay-100">
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-heading font-black text-white tracking-tighter mb-6 lg:mb-8 drop-shadow-sm">
          Gotowy do <span class="text-primary">Startu?</span>
        </h2>
        <p class="text-lg lg:text-xl font-sans text-white/70 mb-10 leading-relaxed mx-auto lg:mx-0 max-w-lg">
          Wypełnij aplikację, a nasz menedżer skontaktuje się z Tobą przez <span class="text-primary font-bold">WhatsApp</span> na krótką rozmowę.
        </p>
        
        <div class="space-y-6 lg:space-y-8 inline-block lg:block text-left">
          <div class="flex gap-x-5 group">
            <div class="shrink-0 w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center border border-white/10 group-hover:bg-primary/20 transition-colors">
              <svg class="w-6 h-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div>
              <span class="block font-heading font-black text-white uppercase text-xs tracking-[0.2em] mb-1">Wsparcie 24/7</span>
              <p class="text-white/60 text-sm font-medium font-sans">Szybka akceptacja kandydata</p>
            </div>
          </div>
          <div class="flex gap-x-5 group">
            <div class="shrink-0 w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center border border-white/10 group-hover:bg-primary/20 transition-colors">
              <svg class="w-6 h-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div>
              <span class="block font-heading font-black text-white uppercase text-xs tracking-[0.2em] mb-1">Przejrzyste</span>
              <p class="text-white/60 text-sm font-medium font-sans">Bez ukrytych opłat i prowizji</p>
            </div>
          </div>
        </div>
      </div>

      <div class="w-full max-w-xl bg-base-100 rounded-[2.5rem] p-6 sm:p-8 md:p-12 shadow-2xl shadow-primary/5 border border-base-content/5 min-h-[650px] flex flex-col justify-center reveal reveal-delay-200"
           x-data={`{
             loading: false,
             success: false,
             error: false,
             errorMessage: '',
             form: {
               first_name: '',
               email: '',
               whatsapp_phone: '',
               citizenship: 'POLSKA',
               has_experience: 'NO',
               code_95: 'NO',
               start_date: '',
               cover_letter: '',
               vacancy_id: '${VACANCY_ID}',
               user_ip: '',
               website: '',
               honeypot: ''
             },
             async init() {
               try {
                 const res = await fetch('https://api.ipify.org?format=json');
                 const data = await res.json();
                 this.form.user_ip = data.ip;
               } catch (e) {
                 console.error('Failed to get IP', e);
               }
             },
             async submitForm() {
               // Проверка наличия vacancy_id
               if (!this.form.vacancy_id) {
                 this.error = true;
                 this.errorMessage = 'Błąd konfiguracji: brak ID wakatu. Skontaktuj się z administratorem.';
                 return;
               }
               
               this.loading = true;
               this.error = false;
               this.errorMessage = '';

               try {
                 const cleanedForm = {
                   ...this.form,
                   whatsapp_phone: this.form.whatsapp_phone.replace(/\\s/g, '')
                 };

                 const response = await fetch('/api/submit-form', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(cleanedForm)
                 });

                 if (response.ok) {
                   this.success = true;
                   
                   window.dataLayer = window.dataLayer || [];
                   window.dataLayer.push({
                     'event': 'form_submission_success',
                     'form_name': 'LeadForm'
                   });

                   this.form.first_name = '';
                   this.form.email = '';
                   this.form.whatsapp_phone = '';
                   this.form.start_date = '';
                   this.form.cover_letter = '';
                   
                   this.$nextTick(() => {
                     this.$el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                   });
                 } else {
                   const errorData = await response.json();
                   this.error = true;
                   this.errorMessage = errorData.message || 'Błąd serwera. Sprawdź poprawność danych.';
                   console.error('Form validation error:', errorData);
                   console.error('Errors details:', JSON.stringify(errorData, null, 2));
                 }
               } catch (e) {
                 this.error = true;
                 this.errorMessage = 'Błąd połączenia. Sprawdź swoje połączenie internetowe.';
                 console.error('Form submission error:', e);
               } finally {
                 this.loading = false;
               }
             }
           }`}>
        
        <form @submit.prevent="submitForm" x-show="!success" x-transition.opacity class="space-y-5">
          <div class="mb-6 lg:mb-8 text-center lg:text-left">
            <h3 class="text-2xl lg:text-3xl font-heading font-black text-base-content tracking-tight">Aplikacja Kierowcy</h3>
            <p class="text-base-content/60 text-sm mt-1 font-medium italic">* Pola wymagane</p>
          </div>

          <div x-show="error" class="alert alert-error mb-6 rounded-xl text-sm font-bold shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span x-text="errorMessage"></span>
          </div>
          
          <!-- Honeypot fields for bot detection (hidden from users) -->
          <input 
            type="text" 
            name="website" 
            x-model="form.website"
            style="position:absolute;left:-9999px;width:1px;height:1px;" 
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          <input 
            type="text" 
            name="honeypot" 
            x-model="form.honeypot"
            style="position:absolute;left:-9999px;width:1px;height:1px;" 
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          
          <input type="hidden" x-model="form.vacancy_id" />
          <input type="hidden" x-model="form.user_ip" />

          <div class="form-control w-full">
            <label class="label" for="lead-first-name"><span class="label-text font-bold font-heading text-base-content/80">TWOJE IMIĘ *</span></label>
            <input type="text" id="lead-first-name" name="first_name" x-model="form.first_name" placeholder="Jan" aria-required="true" class="input input-bordered rounded-xl bg-base-200/50 focus:bg-base-100 transition-all h-12 w-full" required />
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-email"><span class="label-text font-bold font-heading text-base-content/80">TWÓJ EMAIL *</span></label>
            <input type="email" id="lead-email" name="email" x-model="form.email" placeholder="przyklad@mail.com" aria-required="true" class="input input-bordered rounded-xl bg-base-200/50 focus:bg-base-100 transition-all h-12 w-full" required />
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-whatsapp"><span class="label-text font-bold font-heading text-primary">TWÓJ NUMER WHATSAPP *</span></label>
            <input type="tel" id="lead-whatsapp" name="whatsapp_phone" x-model="form.whatsapp_phone" placeholder="+48 000 000 000" aria-required="true" class="input input-bordered rounded-xl border-primary/20 bg-base-200/50 focus:bg-base-100 transition-all h-12 w-full" required />
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-citizenship"><span class="label-text font-bold font-heading text-base-content/80">OBYWATELSTWO</span></label>
            <select id="lead-citizenship" name="citizenship" x-model="form.citizenship" class="select select-bordered rounded-xl bg-base-200/50 font-bold w-full">
              <option value="POLSKA">POLSKA</option>
              <option value="OTHER">INNE</option>
            </select>
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-experience"><span class="label-text font-bold font-heading text-base-content/80">DOŚWIADCZENIE PRACY C+E W UE?</span></label>
            <select id="lead-experience" name="has_experience" x-model="form.has_experience" class="select select-bordered rounded-xl bg-base-200/50 font-bold w-full">
              <option value="NO">NIE</option>
              <option value="YES">TAK</option>
            </select>
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-code95"><span class="label-text font-bold font-heading text-base-content/80">CZY POSIADASZ KOD 95?</span></label>
            <select id="lead-code95" name="code_95" x-model="form.code_95" class="select select-bordered rounded-xl bg-base-200/50 font-bold w-full">
              <option value="NO">NIE</option>
              <option value="YES, POLISH">TAK, POLSKI</option>
              <option value="YES, OTHER EU COUNTRY">TAK, Z INNEGO KRAJU UE</option>
            </select>
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-start-date"><span class="label-text font-bold font-heading text-base-content/80">KIEDY MOŻESZ ZACZĄĆ?</span></label>
<input type="date" id="lead-start-date" name="start_date" x-model="form.start_date" class="input input-bordered rounded-xl bg-base-200/50 focus:bg-base-100 transition-all h-12 w-full" />
          </div>

          <div class="form-control w-full">
            <label class="label" for="lead-cover-letter"><span class="label-text font-bold font-heading text-base-content/80">DODATKOWE INFORMACJE</span></label>
            <textarea id="lead-cover-letter" name="cover_letter" x-model="form.cover_letter" class="textarea textarea-bordered rounded-xl bg-base-200/50 h-24 focus:bg-base-100 w-full" placeholder="List motywacyjny (opcjonalnie)"></textarea>
          </div>

          <div class="form-control">
            <label class="label cursor-pointer justify-start gap-3 items-start" for="lead-gdpr-consent">
              <input type="checkbox" id="lead-gdpr-consent" required class="checkbox checkbox-primary checkbox-sm mt-1" aria-required="true" />
              <span class="label-text text-xs text-base-content/70 leading-relaxed text-justify">
                Wyrażam zgodę na przetwarzanie moich danych osobowych przez {COMPANY_NAME}, z siedzibą przy {COMPANY_ADDRESS_STREET}, {COMPANY_ADDRESS_POSTAL} {COMPANY_ADDRESS_CITY}, w celu rekrutacji na stanowisko, o które się ubiegam.
              </span>
            </label>
          </div>

          <button type="submit" 
                  class="btn btn-primary btn-block text-lg font-heading font-black h-14 rounded-2xl shadow-xl shadow-primary/20 border-none transition-all hover:scale-[1.01] active:scale-95 mt-4" 
                  :disabled="loading"
                  data-gtm-event="form_submit"
                  data-gtm-form="lead_form">
            <span x-show="loading" class="loading loading-spinner"></span>
            <span x-text="loading ? 'Wysyłanie...' : 'Wyślij Aplikację'"></span>
          </button>
        </form>

        <div x-show="success" x-transition.scale.origin.top class="text-center py-12">
           <div class="w-20 h-20 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
           </div>
           <h3 class="text-2xl font-heading font-black text-base-content mb-4 uppercase tracking-tighter">Aplikacja Wysłana!</h3>
           <p class="text-base-content/70 leading-relaxed mb-10 font-medium px-4">Dziękujemy! W przypadku akceptacji wyślemy Ci informacje przez WhatsApp i email.</p>
           
        </div>

      </div>
    </div>
  </div>
</section>